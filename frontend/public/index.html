<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- Required for Relayer WASM workers -->
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin"/>
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp"/>
  <title>Private Dues Status · Zama FHEVM</title>
  <meta name="description" content="Private membership dues: amounts hidden, status only (good/overdue). Zama FHEVM + Relayer SDK 0.2.0."/>

  <!-- Distinct visual: dark aurora + glass cards -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;700;800&family=Space+Mono:wght@700&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg:#0b1220; --ink:#e5ecff; --muted:#9db1cc; --glass:rgba(255,255,255,.06); --line:rgba(255,255,255,.1);
      --ring: rgba(99,102,241,.45);
      --acc1:#7c3aed; --acc2:#22d3ee; --acc3:#14b8a6; --bad:#ef4444; --good:#22c55e;
      --mono:"Space Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      --sans:"Manrope", system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial, sans-serif;
      --r:18px; --shadow:0 30px 80px rgba(2,6,23,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 10% -10%, rgba(124,58,237,.20), transparent 55%),
                      radial-gradient(900px 500px at 110% 10%, rgba(34,211,238,.18), transparent 55%),
                      linear-gradient(180deg,#0b1220,#0b1220 60%, #0f172a);
         color:var(--ink);font-family:var(--sans)}
    header{position:sticky;top:0;z-index:30;background:rgba(11,18,32,.8);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .bar{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:14px}
    .dot{width:44px;height:44px;border-radius:50%;background:conic-gradient(from 210deg,var(--acc1),var(--acc2),var(--acc3),var(--acc1));display:grid;place-items:center;box-shadow:inset 0 0 0 2px rgba(255,255,255,.2)}
    .dot span{font:800 14px var(--mono);color:#0b1220}
    .title{margin:0;font:800 22px var(--sans);letter-spacing:.2px}
    .sub{margin:0;color:var(--muted);font:700 12px var(--mono)}

    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .chip{border:1px solid var(--line);background:var(--glass);backdrop-filter:blur(6px);border-radius:999px;padding:6px 10px;font:700 12px var(--mono);color:#cbd5e1}
    .btn{appearance:none;border:1px solid var(--line);background:linear-gradient(180deg,#10192e,#0b1220);color:#e5ecff;border-radius:14px;padding:10px 14px;font-weight:800;cursor:pointer;transition:.15s;box-shadow:var(--shadow)}
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-pri{background:linear-gradient(180deg,#6366f1,#4f46e5);border-color:#6366f1;color:#fff}

    main{max-width:1200px;margin:24px auto 60px;padding:0 18px}
    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:22px}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}

    .card{background:var(--glass);border:1px solid var(--line);border-radius:var(--r);padding:18px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 6px;font:800 18px var(--sans)}
    .note{font:700 12px var(--mono);color:var(--muted)}

    .rows{display:grid;gap:10px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){.two{grid-template-columns:1fr}}

    label{font:800 11px var(--mono);color:#c7d2fe;letter-spacing:.06em}
    input{width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.04);color:#e5ecff;outline:none;font:800 14px var(--sans)}
    input::placeholder{color:#9db1cc}
    input:focus{box-shadow:0 0 0 4px var(--ring)}

    .status{margin-top:10px;border:1px dashed var(--line);background:rgba(255,255,255,.03);border-radius:14px;padding:12px;min-height:48px;display:flex;align-items:center;justify-content:center;font:700 12px var(--mono);color:#9db1cc}
    .status.ok{border-color:rgba(34,197,94,.4);color:#34d399}
    .status.err{border-color:rgba(239,68,68,.45);color:#fca5a5}

    .handles{font:700 12px var(--mono);color:#e5ecff;background:rgba(255,255,255,.03);border:1px dashed var(--line);border-radius:14px;padding:10px;word-break:break-all}

    .big{font:800 18px var(--sans);display:flex;align-items:center;gap:10px}
    .pill{padding:6px 10px;border-radius:999px;font:800 12px var(--mono);border:1px solid var(--line)}
    .pill.ok{color:#16a34a;border-color:#16a34a;background:rgba(22,163,74,.1)}
    .pill.bad{color:#ef4444;border-color:#ef4444;background:rgba(239,68,68,.08)}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <div class="dot"><span>FHE</span></div>
        <div>
          <div class="title">Private Dues Status</div>
          <div class="sub">Amounts hidden · Public status only · Zama FHEVM · Relayer 0.2.0</div>
        </div>
      </div>
      <div class="row">
        <span id="netChip" class="chip">Network: —</span>
        <span id="addrChip" class="chip">Contract: —</span>
        <button id="btnConnect" class="btn btn-pri">Connect Wallet</button>
      </div>
    </div>
  </header>

  <main>
    <section class="grid">
      <!-- LEFT: Member checks -->
      <article class="card">
        <h2>Member Status</h2>
        <p class="note">We store an encrypted <b>paid-through</b> date per member. Only the boolean status is revealed.</p>
        <div class="rows">
          <div class="two">
            <div>
              <label>Member Address</label>
              <input id="mAddr" type="text" placeholder="0xabc..."/>
            </div>
            <div>
              <label>PaidThrough (epoch seconds)</label>
              <input id="mPaid" type="number" min="0" placeholder="e.g. 1735603200"/>
            </div>
          </div>
          <div class="row">
            <button id="btnSetPaid" class="btn">Set PaidThrough (encrypted)</button>
            <span id="setTx" class="chip">TX: —</span>
          </div>
          <div class="row">
            <button id="btnPriv" class="btn">Check Private</button>
            <button id="btnPubl" class="btn">Check Public</button>
            <span id="statusPill" class="pill">Status: —</span>
          </div>
          <div id="leftLog" class="status">Ready</div>
        </div>
      </article>

      <!-- RIGHT: Admin / Policy -->
      <article class="card">
        <h2>Admin</h2>
        <p class="note">Owner/Treasurer only. Grace period is public (days).</p>
        <div class="rows">
          <div class="two">
            <div>
              <label>Grace Days</label>
              <input id="grace" type="number" min="0" max="365" placeholder="7"/>
            </div>
            <div>
              <label>Treasurer Address</label>
              <input id="treas" type="text" placeholder="0x... (optional)"/>
            </div>
          </div>
          <div class="row">
            <button id="btnSetGrace" class="btn">Set Grace</button>
            <button id="btnSetTreas" class="btn">Set Treasurer</button>
          </div>
          <div class="rows">
            <div class="handles" id="paidHandle">paidThrough handle: —</div>
            <div class="row"><button id="btnGetHandle" class="btn">Get Member Handle</button></div>
          </div>
          <div id="rightLog" class="status">Owner-only actions. Connect wallet.</div>
        </div>
      </article>
    </section>
  </main>

  <footer class="bar" style="background:transparent;border:0;justify-content:flex-start;gap:10px">
    <span class="chip">Built with Ethers v6</span>
    <span class="chip">Relayer SDK 0.2.0</span>
    <span class="chip">Contract: <span id="addrFoot"></span></span>
  </footer>

  <!-- SDKs (ESM) -->
  <script type="module" crossorigin src="https://cdn.zama.org/relayer-sdk-js/0.3.0-5/relayer-sdk-js.js"></script>
  <script type="module" crossorigin src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm"></script>

  <script type="module">
    import { BrowserProvider, Contract } from "https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm";
    import { initSDK, createInstance, SepoliaConfig, generateKeypair } from "https://cdn.zama.org/relayer-sdk-js/0.3.0-5/relayer-sdk-js.js";

    // ===== App Config =====
    const CONTRACT_ADDRESS = "0x005f2A30fb7AB99245800C04BDc11F6c383d19F3"; // deployed
    const RELAYER_URL = "https://relayer.testnet.zama.org";
    const CHAIN_ID_HEX = "0xaa36a7"; // Sepolia

    // ===== ABI (PrivateDuesStatus) =====
    const abi = [
      { inputs: [], name: "version", outputs: [{ type: "string" }], stateMutability: "pure", type: "function" },
      { inputs: [], name: "owner", outputs: [{ type: "address" }], stateMutability: "view", type: "function" },
      { inputs: [], name: "treasurer", outputs: [{ type: "address" }], stateMutability: "view", type: "function" },
      { inputs: [{ name:"newTreasurer", type:"address" }], name:"setTreasurer", outputs: [], stateMutability: "nonpayable", type: "function" },

      { inputs: [], name: "graceDays", outputs: [{ type: "uint16" }], stateMutability: "view", type: "function" },
      { inputs: [{ name:"days_", type:"uint16" }], name:"setGraceDays", outputs: [], stateMutability: "nonpayable", type: "function" },

      { inputs: [{ name:"member", type:"address" }, { name:"paidThroughExt", type:"bytes32" }, { name:"proof", type:"bytes" }], name:"setPaidThroughEncrypted", outputs: [], stateMutability: "nonpayable", type:"function" },

      { inputs: [{ name:"member", type:"address" }], name:"checkStatusPrivate", outputs: [{ type:"bytes1" }], stateMutability: "nonpayable", type:"function" },
      { inputs: [{ name:"member", type:"address" }], name:"checkStatusPublic",  outputs: [{ type:"bytes1" }], stateMutability: "nonpayable", type:"function" },

      { inputs: [{ name:"member", type:"address" }], name:"getPaidThroughHandle", outputs: [{ type:"bytes32" }], stateMutability: "view", type:"function" },

      // events used for handles
      { anonymous:false, inputs:[{indexed:true,name:"caller",type:"address"},{indexed:true,name:"member",type:"address"},{indexed:false,name:"statusHandle",type:"bytes32"}], name:"StatusCheckedPrivate", type:"event" },
      { anonymous:false, inputs:[{indexed:true,name:"caller",type:"address"},{indexed:true,name:"member",type:"address"},{indexed:false,name:"statusHandle",type:"bytes32"}], name:"StatusCheckedPublic",  type:"event" },
      { anonymous:false, inputs:[{indexed:true,name:"member",type:"address"},{indexed:false,name:"paidThroughHandle",type:"bytes32"}], name:"MemberRegistered", type:"event" },
      { anonymous:false, inputs:[{indexed:true,name:"member",type:"address"},{indexed:false,name:"paidThroughHandle",type:"bytes32"}], name:"MemberUpdated",    type:"event" }
    ];

    // ===== Elements =====
    const $ = (id) => document.getElementById(id);
    const els = {
      btnConnect: $("btnConnect"), netChip: $("netChip"), addrChip: $("addrChip"), addrFoot: $("addrFoot"),
      mAddr: $("mAddr"), mPaid: $("mPaid"), btnSetPaid: $("btnSetPaid"), setTx: $("setTx"), btnPriv: $("btnPriv"), btnPubl: $("btnPubl"), statusPill: $("statusPill"), leftLog: $("leftLog"),
      grace: $("grace"), treas: $("treas"), btnSetGrace: $("btnSetGrace"), btnSetTreas: $("btnSetTreas"), rightLog: $("rightLog"),
      paidHandle: $("paidHandle"), btnGetHandle: $("btnGetHandle"),
    };

    els.addrChip.textContent = `Contract: ${CONTRACT_ADDRESS}`;
    els.addrFoot.textContent = CONTRACT_ADDRESS;

    // ===== State =====
    let provider, signer, user, contract, relayer, isOwner=false, isTreas=false;

    const LOG = {
      info:(el, s) => { el.textContent = s; el.className = "status"; console.log("[INFO]", s); },
      ok:(el, s)   => { el.textContent = s; el.className = "status ok"; console.log("[OK]", s); },
      err:(el, s)  => { el.textContent = s; el.className = "status err"; console.error("[ERR]", s); },
    };

    // ===== Bind =====
    els.btnConnect.addEventListener('click', connect);
    els.btnSetPaid.addEventListener('click', setPaidThrough);
    els.btnPriv.addEventListener('click', checkPrivate);
    els.btnPubl.addEventListener('click', checkPublic);
    els.btnSetGrace.addEventListener('click', setGrace);
    els.btnSetTreas.addEventListener('click', setTreasurer);
    els.btnGetHandle.addEventListener('click', getHandle);

    // ===== Connect =====
    async function connect(){
      try{
        if(!window.ethereum) throw new Error("MetaMask not found");
        provider = new BrowserProvider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        let net = await provider.getNetwork();
        if(net.chainId !== 11155111n){ await provider.send('wallet_switchEthereumChain', [{ chainId: CHAIN_ID_HEX }]); net = await provider.getNetwork(); }
        els.netChip.textContent = `Network: Sepolia (${String(net.chainId)})`;

        signer = await provider.getSigner();
        user = await signer.getAddress();
        els.btnConnect.textContent = `${user.slice(0,6)}…${user.slice(-4)}`;
        els.btnConnect.disabled = true;

        contract = new Contract(CONTRACT_ADDRESS, abi, signer);

        await initSDK();
        relayer = await createInstance({ ...SepoliaConfig, relayerUrl: RELAYER_URL, network: window.ethereum, debug:true });

        // roles
        try{ const o = await contract.owner(); isOwner = (o.toLowerCase()===user.toLowerCase()); }catch{}
        try{ const t = await contract.treasurer(); isTreas = (t.toLowerCase()===user.toLowerCase()); }catch{}
        const role = isOwner? "Owner" : isTreas? "Treasurer" : "Member";
        LOG.ok(els.rightLog, `${role} connected ✓`);

        // grace placeholder
        try{ const g = await contract.graceDays(); els.grace.placeholder = String(g); }catch{}
      }catch(e){ alert(e.message || String(e)); }
    }

    // ===== Helpers =====
    const isAddr = (s)=> /^0x[a-fA-F0-9]{40}$/.test(String(s||""));
    const isU32  = (n)=> Number.isInteger(n) && n >= 0 && n <= 0xffffffff;

    // ===== Admin ops =====
    async function setGrace(){
      try{
        if(!(isOwner)) throw new Error('Owner only');
        const d = Number(els.grace.value||"0"); if(!Number.isInteger(d) || d<0 || d>365) throw new Error('Grace 0..365');
        const tx = await contract.setGraceDays(d); els.rightLog.textContent = `TX: ${tx.hash}`; await tx.wait(); LOG.ok(els.rightLog, 'Grace updated ✓');
      }catch(e){ LOG.err(els.rightLog, e.message||String(e)); }
    }
    async function setTreasurer(){
      try{
        if(!(isOwner)) throw new Error('Owner only');
        const a = (els.treas.value||"").trim(); if(!isAddr(a)) throw new Error('Bad address');
        const tx = await contract.setTreasurer(a); els.rightLog.textContent = `TX: ${tx.hash}`; await tx.wait(); LOG.ok(els.rightLog, 'Treasurer set ✓');
      }catch(e){ LOG.err(els.rightLog, e.message||String(e)); }
    }

    // ===== Member ops =====
    async function setPaidThrough(){
      try{
        if(!(isOwner||isTreas)) throw new Error('Owner or Treasurer only');
        const m = (els.mAddr.value||"").trim(); if(!isAddr(m)) throw new Error('Enter member address');
        const paid = Number(els.mPaid.value||"0"); if(!isU32(paid)) throw new Error('epoch seconds (uint32)');
        LOG.info(els.leftLog, 'Encrypting paidThrough…');
        const buf = relayer.createEncryptedInput(CONTRACT_ADDRESS, user);
        buf.add32(paid);
        const { handles, inputProof } = await buf.encrypt();
        try { await contract.setPaidThroughEncrypted.staticCall(m, handles[0], inputProof); } catch {}
        const tx = await contract.setPaidThroughEncrypted(m, handles[0], inputProof);
        els.setTx.textContent = `TX: ${tx.hash}`; await tx.wait(); LOG.ok(els.leftLog, 'PaidThrough set ✓');
      }catch(e){ LOG.err(els.leftLog, e.message||String(e)); }
    }

    // private status (userDecrypt)
    async function checkPrivate(){
      try{
        if(!relayer || !contract) await connect();
        const m = (els.mAddr.value||"").trim(); if(!isAddr(m)) throw new Error('Enter member address');
        LOG.info(els.leftLog, 'Submitting private check…');
        const tx = await contract.checkStatusPrivate(m); const rcpt = await tx.wait();
        const topic = contract.interface.getEvent('StatusCheckedPrivate').topicHash;
        const log = rcpt.logs.find(l=>l.topics?.[0]===topic);
        if(!log) throw new Error('No event found');
        const parsed = contract.interface.parseLog(log);
        const handle = parsed.args.statusHandle;

        // userDecrypt with EIP-712
        LOG.info(els.leftLog, 'Decrypting (private)…');
        const kp = await generateKeypair();
        const startTs = Math.floor(Date.now()/1000).toString();
        const days = '7';
        const eip = relayer.createEIP712(kp.publicKey, [CONTRACT_ADDRESS], startTs, days);
        const sig = await signer.signTypedData(eip.domain, { UserDecryptRequestVerification: eip.types.UserDecryptRequestVerification }, eip.message);
        const pairs = [{ handle: String(handle), contractAddress: CONTRACT_ADDRESS }];
        const out = await relayer.userDecrypt(pairs, kp.privateKey, kp.publicKey, sig.replace('0x',''), [CONTRACT_ADDRESS], user, startTs, days);
        let v = out[handle] ?? out[String(handle)];
        const ok = (v===true || v==='true' || v===1 || v==='1');
        els.statusPill.textContent = ok ? 'Status: IN GOOD STANDING' : 'Status: OVERDUE';
        els.statusPill.className = 'pill '+(ok?'ok':'bad');
        LOG.ok(els.leftLog, 'Done');
      }catch(e){ LOG.err(els.leftLog, e.message||String(e)); }
    }

    // public status (publicDecrypt)
    async function checkPublic(){
      try{
        if(!relayer || !contract) await connect();
        const m = (els.mAddr.value||"").trim(); if(!isAddr(m)) throw new Error('Enter member address');
        LOG.info(els.leftLog, 'Submitting public check…');
        const tx = await contract.checkStatusPublic(m); const rcpt = await tx.wait();
        const topic = contract.interface.getEvent('StatusCheckedPublic').topicHash;
        const log = rcpt.logs.find(l=>l.topics?.[0]===topic);
        if(!log) throw new Error('No event found');
        const parsed = contract.interface.parseLog(log);
        const handle = parsed.args.statusHandle;

        LOG.info(els.leftLog, 'Decrypting (public)…');
        const pairs = [{ handle: String(handle), contractAddress: CONTRACT_ADDRESS }];
        let out;
        try{ out = await relayer.publicDecrypt(pairs); }
        catch(e1){ try{ out = await relayer.publicDecrypt([String(handle)]); } catch(e2){ throw e1; } }
        let v = out[handle] ?? out[String(handle)] ?? (Array.isArray(out)? out[0] : undefined);
        const ok = (v===true || v==='true' || v===1 || v==='1');
        els.statusPill.textContent = ok ? 'Status: IN GOOD STANDING' : 'Status: OVERDUE';
        els.statusPill.className = 'pill '+(ok?'ok':'bad');
        LOG.ok(els.leftLog, 'Done');
      }catch(e){ LOG.err(els.leftLog, e.message||String(e)); }
    }

    async function getHandle(){
      try{
        const m = (els.mAddr.value||"").trim(); if(!isAddr(m)) throw new Error('Enter member address');
        const h = await contract.getPaidThroughHandle(m); els.paidHandle.textContent = 'paidThrough handle: '+h;
      }catch(e){ LOG.err(els.rightLog, e.message||String(e)); }
    }
  </script>
</body>
</html>
